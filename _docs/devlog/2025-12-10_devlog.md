# Devlog: 2025-12-10

## Session Focus: Unified User Store Architecture

### Problem Statement

The project had **fragmented user data** across multiple systems:

1. **Content Users** (`src/content/users/*.md`) - Static build-time data
2. **Mock Users** (`src/lib/auth/mock-user.ts`) - Hardcoded credentials
3. **Auth Store** (`src/lib/auth/store.ts`) - Runtime login state
4. **localStorage hacks** - Profile edit overrides

This caused:
- Data duplication
- No sync between systems
- Profile edits lost on page reload
- Confusing architecture

### Solution: Single Source of Truth

Created `src/lib/auth/userStore.ts` as the **unified user store**:

```
┌─────────────────────────────────────────────────────────────────┐
│                    UNIFIED USER STORE                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  DEFAULT_USERS (immutable)     usersStore (editable)           │
│  ├─ id, email, password        ├─ name ✏️                      │
│  ├─ role, accessLevel          ├─ avatar ✏️                    │
│  └─ createdAt                  ├─ bio ✏️                       │
│                                └─ isActive                      │
│                                                                 │
│  API: getUserById(), updateUserProfile(), validateCredentials() │
│       subscribeToUser(), searchUsers(), getAllUsers()          │
└─────────────────────────────────────────────────────────────────┘
```

### Data Flow

1. **Login** → `userStore.validateCredentials()` → copies to `authStore`
2. **Profile Edit** → `userStore.updateUserProfile()` → auto-syncs to `authStore`
3. **UI Display** → subscribes to `userStore` → auto-updates on changes
4. **Page Reload** → `restoreAuthSubscription()` → re-syncs data

### Files Created

| File | Purpose |
|------|---------|
| `src/lib/auth/userStore.ts` | Single source of truth for user data |
| `src/pages/users/[id].astro` | Editable user profile page |
| `src/pages/users/index.astro` | User directory (internal use) |
| `src/components/guards/OwnerGuard.astro` | RBAC UI protection |
| `src/components/search/GlobalSearch.astro` | Site-wide search |
| `.cursorrules` | AI assistant context |

### Files Modified

| File | Change |
|------|--------|
| `src/lib/auth/store.ts` | Syncs with userStore on login/changes |
| `src/lib/auth/index.ts` | Exports all userStore functions |
| `src/lib/auth/mock-user.ts` | Marked deprecated |
| `src/pages/profile/index.astro` | Redirects to `/users/{id}/` |
| `src/layouts/Base.astro` | Removed "Users" nav link |
| `src/lib/debug.ts` | Added auth-specific logging |

### UX Improvements

- ✅ "Profile" dropdown → goes to editable profile
- ✅ Removed public user directory from navigation
- ✅ Profile edits persist to localStorage
- ✅ Header updates when profile changes
- ✅ 4 user roles with different permission levels

### RBAC Permission Levels

| Role | Level | Capabilities |
|------|-------|--------------|
| admin | 10 | Full CRUD on everything |
| editor | 5 | Create, Read, Update any (no delete) |
| contributor | 3 | CRUD on own content only |
| viewer | 1 | Read public content only |

### Architecture Decisions

1. **No backend needed** - localStorage persistence works for demo/personal wiki
2. **Web Components over React** - Keeps bundle small, no framework dependency
3. **Nanostores for state** - Lightweight, works with Astro's islands
4. **Build-time + Runtime bridge** - Content collection IDs match userStore IDs

### Commits

```
cb7efdb docs: add .cursorrules for AI assistant context
eab997e fix: remove Users nav link from header
cf71dc0 fix: /profile/ now redirects to user's editable profile
1d86d4e feat: add unified user store with RBAC authentication system
```

### Commits (Early Session)

```
cb7efdb docs: add .cursorrules for AI assistant context
eab997e fix: remove Users nav link from header
cf71dc0 fix: /profile/ now redirects to user's editable profile
1d86d4e feat: add unified user store with RBAC authentication system
```

---

## Session 2: Auth Gating & Route Protection

### Problem Statement

After implementing the auth system, content pages were still publicly accessible. Anyone could visit `/faq/introduction/` or `/users/` without logging in.

### Solution: Comprehensive Auth Gating

Implemented auth gates on ALL protected routes:

| Route | Protection Added |
|-------|-----------------|
| `/` | Auth gate → login redirect |
| `/[...slug].astro` | Auth gate for ALL content (FAQ, Notes, Tools) |
| `/users/` | Auth gate for directory |
| `/users/[id]/` | Auth gate for profiles |
| `/profile/index.astro` | Fixed hydration timing |
| `/login/` | Redirect if already logged in |
| `/logout/` | Redirect to `/login/` instead of `/` |

### Auth Gate Pattern

```astro
<!-- Show loading spinner -->
<div id="auth-gate" class="auth-gate">
  <div class="loading-spinner"></div>
  <p>Loading...</p>
</div>

<!-- Content hidden until auth verified -->
<div id="content" style="display: none;">
  ...
</div>

<script>
  import { authStore } from '../lib/auth';

  async function checkAuth() {
    await new Promise((r) => setTimeout(r, 100)); // Wait for hydration
    const state = authStore.get();
    
    if (state.isLoggedIn !== 'true') {
      window.location.href = '/login/?redirect=' + encodeURIComponent(window.location.pathname);
    } else {
      document.getElementById('auth-gate').style.display = 'none';
      document.getElementById('content').style.display = 'block';
    }
  }

  checkAuth();

  // Listen for logout
  authStore.subscribe(() => {
    const state = authStore.get();
    if (state.isLoggedIn !== 'true') {
      window.location.href = '/login/';
    }
  });
</script>
```

### Route Classification

**Protected (require login):**
- `/` - Home
- `/faq/*` - FAQ content
- `/notes/*` - Notes content  
- `/tools/*` - Tools content
- `/users/` - Directory
- `/users/[id]/` - Profiles
- `/profile/*` - Profile routes

**Public (no auth):**
- `/login/` - Entry point
- `/disclaimer/` - Legal requirement

### Why localStorage?

Documented the architectural decision:

| Reason | Explanation |
|--------|-------------|
| No backend | Static/SSR site on Cloudflare |
| Client-side auth | Credentials checked in JS |
| Demo scope | UX prototype, not real security |
| Simplicity | Zero server dependencies |

For production, would need: HttpOnly cookies, server sessions, CSRF protection.

### Documentation Created

- `_docs/AUTH.md` - Full auth system documentation
- Updated `README.md` - Added auth section with test credentials
- Updated `_docs/ARCHITECTURE.md` - Auth architecture diagrams (earlier)

### Commits (Session 2)

```
39a3bc4 feat: make login page first entry point, redirect logout to login
1ceaf47 fix: comprehensive auth gating across all routes
[pending] docs: add comprehensive auth documentation
```

### Next Steps (Future Sessions)

- [ ] Add tools pages with ownership display
- [ ] Implement content editing (not just profile)
- [ ] Add activity stats to profile page
- [ ] Consider backend migration for multi-device sync
