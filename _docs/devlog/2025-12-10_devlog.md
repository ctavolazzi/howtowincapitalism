# Devlog: 2025-12-10

## Session Focus: Unified User Store Architecture

### Problem Statement

The project had **fragmented user data** across multiple systems:

1. **Content Users** (`src/content/users/*.md`) - Static build-time data
2. **Mock Users** (`src/lib/auth/mock-user.ts`) - Hardcoded credentials
3. **Auth Store** (`src/lib/auth/store.ts`) - Runtime login state
4. **localStorage hacks** - Profile edit overrides

This caused:
- Data duplication
- No sync between systems
- Profile edits lost on page reload
- Confusing architecture

### Solution: Single Source of Truth

Created `src/lib/auth/userStore.ts` as the **unified user store**:

```
┌─────────────────────────────────────────────────────────────────┐
│                    UNIFIED USER STORE                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  DEFAULT_USERS (immutable)     usersStore (editable)           │
│  ├─ id, email, password        ├─ name ✏️                      │
│  ├─ role, accessLevel          ├─ avatar ✏️                    │
│  └─ createdAt                  ├─ bio ✏️                       │
│                                └─ isActive                      │
│                                                                 │
│  API: getUserById(), updateUserProfile(), validateCredentials() │
│       subscribeToUser(), searchUsers(), getAllUsers()          │
└─────────────────────────────────────────────────────────────────┘
```

### Data Flow

1. **Login** → `userStore.validateCredentials()` → copies to `authStore`
2. **Profile Edit** → `userStore.updateUserProfile()` → auto-syncs to `authStore`
3. **UI Display** → subscribes to `userStore` → auto-updates on changes
4. **Page Reload** → `restoreAuthSubscription()` → re-syncs data

### Files Created

| File | Purpose |
|------|---------|
| `src/lib/auth/userStore.ts` | Single source of truth for user data |
| `src/pages/users/[id].astro` | Editable user profile page |
| `src/pages/users/index.astro` | User directory (internal use) |
| `src/components/guards/OwnerGuard.astro` | RBAC UI protection |
| `src/components/search/GlobalSearch.astro` | Site-wide search |
| `.cursorrules` | AI assistant context |

### Files Modified

| File | Change |
|------|--------|
| `src/lib/auth/store.ts` | Syncs with userStore on login/changes |
| `src/lib/auth/index.ts` | Exports all userStore functions |
| `src/lib/auth/mock-user.ts` | Marked deprecated |
| `src/pages/profile/index.astro` | Redirects to `/users/{id}/` |
| `src/layouts/Base.astro` | Removed "Users" nav link |
| `src/lib/debug.ts` | Added auth-specific logging |

### UX Improvements

- ✅ "Profile" dropdown → goes to editable profile
- ✅ Removed public user directory from navigation
- ✅ Profile edits persist to localStorage
- ✅ Header updates when profile changes
- ✅ 4 user roles with different permission levels

### RBAC Permission Levels

| Role | Level | Capabilities |
|------|-------|--------------|
| admin | 10 | Full CRUD on everything |
| editor | 5 | Create, Read, Update any (no delete) |
| contributor | 3 | CRUD on own content only |
| viewer | 1 | Read public content only |

### Architecture Decisions

1. **No backend needed** - localStorage persistence works for demo/personal wiki
2. **Web Components over React** - Keeps bundle small, no framework dependency
3. **Nanostores for state** - Lightweight, works with Astro's islands
4. **Build-time + Runtime bridge** - Content collection IDs match userStore IDs

### Commits

```
cb7efdb docs: add .cursorrules for AI assistant context
eab997e fix: remove Users nav link from header
cf71dc0 fix: /profile/ now redirects to user's editable profile
1d86d4e feat: add unified user store with RBAC authentication system
```

### Next Steps (Future Sessions)

- [ ] Add tools pages with ownership display
- [ ] Implement content editing (not just profile)
- [ ] Add activity stats to profile page
- [ ] Consider backend migration for multi-device sync
