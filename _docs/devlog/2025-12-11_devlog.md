# Devlog: 2025-12-11

## Session Focus: Cloudflare KV Auth - Production Ready

### Summary

Major security fixes and production deployment of Cloudflare KV authentication system.

### Key Accomplishments

1. âœ… **Security Fix: Client-Side Password Exposure**
   - Discovered passwords were being bundled into client-side JavaScript
   - Removed `DEFAULT_USERS` passwords from `userStore.ts`
   - Removed `validateCredentials()` from client-side code
   - Passwords now exist ONLY in server-side files (`local-auth.ts`, `kv-auth.ts`)

2. âœ… **Credential Rotation (GitGuardian Alert)**
   - Old passwords were exposed in git history
   - Rotated all test credentials to new secure values
   - Updated: `local-auth.ts`, `seed-users.mjs`, all test files, `.cursorrules`
   - Reseeded Cloudflare KV with new hashed passwords

3. âœ… **Fixed KV Seeding Bug**
   - Discovered wrangler was defaulting to LOCAL storage, not REMOTE
   - Added `--remote` flag to all KV operations in seed script
   - Verified data now exists in actual Cloudflare KV namespace

4. âœ… **Cloudflare Pages KV Bindings**
   - Configured bindings in Cloudflare Dashboard (Settings â†’ Functions â†’ Bindings)
   - `USERS` â†’ namespace ID `5b575785cbaa4b9e90e324501799cd39`
   - `SESSIONS` â†’ namespace ID `33ad9f43586e4d11a6059275ced626af`

5. âœ… **UX: Password Visibility Toggle**
   - Added eye icon to login form password field
   - Click to show/hide password
   - Proper accessibility (aria-label updates)

6. âœ… **Removed Site-Wide Password Gate**
   - Removed the simple `unlockmenow` password overlay
   - Now using proper Cloudflare KV authentication
   - Users must log in with real credentials

### Files Changed

| File | Change |
|------|--------|
| `src/lib/auth/userStore.ts` | Removed passwords from DEFAULT_USERS |
| `src/lib/auth/store.ts` | Deprecated client-side login(), added setAuthFromUser() |
| `src/lib/auth/index.ts` | Removed MOCK_USERS export |
| `src/lib/auth/local-auth.ts` | New secure passwords |
| `src/lib/auth/kv-auth.ts` | Cleaned up debug logging |
| `src/pages/api/auth/login.ts` | Removed debug code |
| `src/components/auth/LoginForm.astro` | Added password visibility toggle |
| `src/layouts/Base.astro` | Removed password gate overlay |
| `scripts/seed-users.mjs` | Added --remote flag, new passwords |
| `wrangler.toml` | Updated with Pages config from Cloudflare |
| `tests/*.spec.ts` | Updated with new test credentials |
| `.cursorrules` | Updated test credentials |
| `_docs/AUTH.md` | Updated test credentials |

### New Test Credentials

| Email | Password | Role |
|-------|----------|------|
| admin@email.com | test_admin1 | admin |
| editor@email.com | test_editor1 | editor |
| contributor@email.com | test_contrib1 | contributor |
| viewer@email.com | test_viewer1 | viewer |

### Security Improvements

| Before | After |
|--------|-------|
| Passwords in client JS bundle | Passwords only on server |
| Simple shared password | Individual user accounts |
| Session in sessionStorage | httpOnly cookies |
| No password hashing | SHA-256 with salt |
| Passwords in git history | Rotated (old ones useless) |

### Technical Notes

**The `--remote` flag issue:**
```bash
# This writes to LOCAL (wrong!)
wrangler kv key put --namespace-id=xxx "key" "value"

# This writes to REMOTE (correct!)
wrangler kv key put --namespace-id=xxx --remote "key" "value"
```

**Pages KV Bindings:**
- `wrangler.toml` bindings only work for local dev (`wrangler pages dev`)
- Production bindings must be configured in Cloudflare Dashboard
- Dashboard: Pages â†’ Project â†’ Settings â†’ Functions â†’ KV namespace bindings

### Commits

```
8c820a0 security: remove passwords from client-side bundles
c9c1611 security: rotate all test credentials after GitGuardian alert
125df97 fix: KV seeding now uses --remote flag
c4b45e0 feat: remove site-wide password gate
```

### Status

ðŸŸ¢ **PRODUCTION READY**

- Login works at https://howtowincapitalism.com/login/
- All 4 user roles functional
- Proper security (httpOnly cookies, hashed passwords)
- No client-side password exposure

### Next Steps

- [ ] Clean up test files (remove dead unlockGate code)
- [ ] Add "Forgot Password" flow (if needed)
- [x] ~~Consider adding user registration (admin-only?)~~ â†’ Implemented!
- [ ] Update work effort status to completed

---

## Session 2: User Registration with Email Confirmation

**Time:** 11:00 PM PST

### Summary

Implemented full user registration flow with email confirmation using TDD approach.

### Key Accomplishments

1. âœ… **Registration API Endpoint** (`/api/auth/register`)
   - Validates username, email, password
   - Creates unconfirmed user in Cloudflare KV
   - Sends confirmation email via Resend

2. âœ… **Email Confirmation Flow**
   - Generates secure confirmation token (32 bytes)
   - Token stored in KV with 24-hour TTL
   - GET `/api/auth/confirm?token=xxx` confirms email
   - Redirects to success or error page

3. âœ… **Registration UI**
   - `/register/` page with form
   - Username, name, email, password fields
   - Client-side and server-side validation
   - Success message on completion

4. âœ… **Confirmation Pages**
   - `/confirm/success/` - Email verified, link to login
   - `/confirm/error/` - Invalid/expired token, retry options

5. âœ… **Login Integration**
   - Updated login to check `emailConfirmed` status
   - Unconfirmed users see "please confirm email" message
   - Added "Create account" link on login page

6. âœ… **E2E Tests (TDD)**
   - Created `tests/registration.spec.ts`
   - Tests for form display, validation, success, duplicates
   - Tests for confirmation endpoints

### New Files

| File | Purpose |
|------|---------|
| `src/pages/api/auth/register.ts` | Registration endpoint |
| `src/pages/api/auth/confirm.ts` | Email confirmation endpoint |
| `src/pages/register/index.astro` | Registration page |
| `src/pages/confirm/success/index.astro` | Confirmation success |
| `src/pages/confirm/error/index.astro` | Confirmation error |
| `src/components/auth/RegisterForm.astro` | Registration form |
| `src/lib/email/send-confirmation.ts` | Resend email sender |
| `tests/registration.spec.ts` | E2E tests |

### Updated Files

| File | Change |
|------|--------|
| `src/lib/auth/kv-auth.ts` | Added emailConfirmed, confirmToken fields, createUser(), confirmEmail() |
| `src/pages/api/auth/login.ts` | Check for email confirmation |
| `src/components/auth/LoginForm.astro` | Added register link |
| `scripts/seed-users.mjs` | Added emailConfirmed: true for seed users |
| `package.json` | Added resend dependency |
| `src/env.d.ts` | Added RESEND_API_KEY to Env |

### Email Service: Resend

**Setup required:**
1. Sign up at https://resend.com
2. Create API key
3. Add to Cloudflare: Dashboard â†’ Pages â†’ Settings â†’ Environment Variables
4. Add `RESEND_API_KEY` = `re_xxxxx`

**Note:** For production, also need to verify sending domain in Resend dashboard.

### Test User for Registration

| Field | Value |
|-------|-------|
| Username | folktechnica |
| Name | Folk Technica |
| Email | folktechnica@gmail.com |
| Password | test_user1 |

### Technical Notes

**KV Schema Update:**
```typescript
interface KVUser {
  // ... existing fields
  emailConfirmed: boolean;      // NEW
  confirmToken?: string;        // NEW (temporary)
  confirmTokenExpires?: string; // NEW (24h expiry)
}
```

**Confirmation Flow:**
```
User submits registration form
       â†“
POST /api/auth/register
       â†“
Create user with emailConfirmed: false
       â†“
Send email via Resend
       â†“
User clicks link in email
       â†“
GET /api/auth/confirm?token=xxx
       â†“
Set emailConfirmed: true, delete token
       â†“
Redirect to /confirm/success/
```

### Status

ðŸŸ¡ **READY FOR TESTING**

- Run `npm install` to get resend package
- Add RESEND_API_KEY to Cloudflare environment
- Re-seed users: `npm run seed:users`
- Test registration flow

---

## Session 3: MECANIK DEV Auth System Comparison

**Time:** 11:22 PM PST

### Summary

Compared our auth system to [MECANIK DEV's Cloudflare Pages auth system](https://mecanik.dev/posts/cloudflare-pages-register-login-user-system/) to identify security gaps and best practices.

### Key Findings

**Similarity Score: ~70%** â€” Same fundamental architecture, different feature emphasis.

#### What They Have That We Don't

| Feature | Priority | Notes |
|---------|----------|-------|
| **CSRF Protection** | ðŸ”´ High | Encrypted tokens via HTMLRewriter |
| **Per-User Password Salts** | ðŸ”´ High | We use static salt, they use random per-user |
| **Password Reset Flow** | ðŸ”´ High | /forgot-password, email link, /password-reset |
| **Login History** | ðŸŸ¡ Medium | USERS_LOGIN_HISTORY KV namespace |
| **Session Mapping** | ðŸŸ¢ Low | KV eventual consistency workaround |
| **Dummy Form Fields** | ðŸŸ¡ Medium | Random hidden inputs to confuse bots |

#### What We Have That They Don't

| Feature | Benefit |
|---------|---------|
| Full RBAC (4-role permission matrix) | Granular access control |
| Client-side reactive state (nanostores) | Better UX, no page reloads |
| Local dev fallback (mock auth) | Easier development |
| Profile editing | Self-service user management |
| Activity tracking | User behavior insights |

### Shared Architecture

Both systems use:
- Cloudflare Pages + Workers KV
- Server-side sessions (no JWT)
- httpOnly cookies with Secure, SameSite=Strict
- Email confirmation flow
- POST-based API routes

### MECANIK's CSRF Approach (Worth Adopting)

```typescript
// Generate (on page load via HTMLRewriter)
const CSRF_TOKEN = JSON.stringify({
  i: request.headers.get('CF-Connecting-IP'),
  c: request.headers.get('CF-IPCountry'),
  u: request.headers.get('User-Agent'),
  e: Date.now() + 60000  // 1 minute expiry
});
const encrypted = await encryptData(CSRF_TOKEN, env.CSRF_SECRET);
// Inject: <input type="hidden" name="csrf" value="${encrypted}" />

// Validate (on POST)
if (IP !== parsed.i || Date.now() > parsed.e) {
  return new Response('Invalid CSRF', { status: 403 });
}
```

### MECANIK's Password Hashing (Worth Adopting)

```typescript
// PBKDF2 with per-user random salt (10,000 iterations)
const salt = crypto.getRandomValues(new Uint8Array(16));
const key = await crypto.subtle.deriveBits({
  name: 'PBKDF2', salt, iterations: 10000, hash: 'SHA-256'
}, passwordKey, 256);
// Store: `${saltHex}:${hashHex}`
```

### Updated Work Efforts

1. **10.09_user_registration_email_confirmation.md**
   - Added security improvements section
   - Documented CSRF and password hashing gaps
   - Added MECANIK reference link

2. **10.10_security_audit.md**
   - Added MECANIK comparison findings section
   - Added Phase 1.5: CSRF Protection tasks
   - Added Phase 1.6: Password Reset Flow tasks
   - Updated critical checklist with new items
   - Upgraded password hashing priority with code samples

### Architecture Doc Merged

PR #2 merged: `_docs/ARCHITECTURE_ANALYSIS.md` (724 lines)
- High-level system diagrams
- 8 design patterns documented
- Data flow visualizations
- Complements this security comparison

### Next Steps

- [ ] Implement CSRF protection
- [ ] Upgrade password hashing to PBKDF2
- [x] ~~Build password reset flow~~ â†’ Implemented in Session 4!
- [ ] Consider login history tracking

### References

- [MECANIK DEV: Cloudflare Pages Auth](https://mecanik.dev/posts/cloudflare-pages-register-login-user-system/)
- `_docs/ARCHITECTURE_ANALYSIS.md`
- Work effort: `10.10_security_audit.md`

---

## Session 4: Forgot Password Flow Implementation

**Time:** 10:45 PM PST

### Summary

Implemented complete "Forgot Password" flow with email-based password reset using Resend.

### Key Accomplishments

1. âœ… **KV Auth Extensions** (`src/lib/auth/kv-auth.ts`)
   - `generateResetToken()` - Creates secure 32-byte reset tokens
   - `createPasswordReset()` - Stores reset request in KV with 1-hour TTL
   - `resetPassword()` - Validates token and updates password
   - `validateResetToken()` - Checks token validity without consuming it

2. âœ… **Password Reset Email** (`src/lib/email/send-password-reset.ts`)
   - HTML + plaintext email template
   - Resend integration (same as registration emails)
   - 1-hour expiry warning in email

3. âœ… **API Routes**
   - `POST /api/auth/forgot-password` - Requests reset email (always returns success for security)
   - `POST /api/auth/reset-password` - Resets password with valid token
   - `GET /api/auth/reset-password?token=xxx` - Validates token before showing form

4. âœ… **UI Components**
   - `ForgotPasswordForm.astro` - Email input form
   - `ResetPasswordForm.astro` - New password form with token validation

5. âœ… **Pages**
   - `/forgot-password/` - Request password reset
   - `/reset-password/` - Set new password (token from URL)

6. âœ… **Login Form Update**
   - Added "Forgot password?" link under password field

### New Files

| File | Purpose |
|------|---------|
| `src/lib/email/send-password-reset.ts` | Password reset email template |
| `src/pages/api/auth/forgot-password.ts` | Request reset endpoint |
| `src/pages/api/auth/reset-password.ts` | Reset password endpoint |
| `src/components/auth/ForgotPasswordForm.astro` | Email input form |
| `src/components/auth/ResetPasswordForm.astro` | New password form |
| `src/pages/forgot-password/index.astro` | Forgot password page |
| `src/pages/reset-password/index.astro` | Reset password page |

### Updated Files

| File | Change |
|------|--------|
| `src/lib/auth/kv-auth.ts` | Added password reset functions |
| `src/components/auth/LoginForm.astro` | Added "Forgot password?" link |

### Password Reset Flow

```
User clicks "Forgot password?" on login page
       â†“
POST /api/auth/forgot-password { email }
       â†“
Create reset token in KV (1-hour TTL)
       â†“
Send email via Resend
       â†“
User clicks link in email
       â†“
GET /reset-password/?token=xxx
       â†“
Validate token, show password form
       â†“
POST /api/auth/reset-password { token, password }
       â†“
Update password, delete token
       â†“
Redirect to login
```

### Security Considerations

- **No email enumeration**: `/api/auth/forgot-password` always returns success
- **One-time tokens**: Tokens deleted after successful reset
- **1-hour expiry**: Short TTL for reset tokens
- **Password validation**: Same rules as registration (8+ chars, letters + numbers)
- **Token stored in KV**: Uses same secure pattern as session tokens

### Technical Notes

**KV Schema for Reset Tokens:**
```typescript
// Key: reset:{token}
// Value:
{
  userId: string,
  email: string,
  createdAt: string,
  expiresAt: string
}
// TTL: 3600 seconds (1 hour)
```

### Dependencies

Same as registration flow:
- `RESEND_API_KEY` environment variable required
- Domain verification in Resend dashboard for production emails

### Status

ðŸŸ¡ **READY FOR TESTING**

- Add `RESEND_API_KEY` to Cloudflare environment (if not already done)
- Test flow: Login â†’ Forgot password â†’ Check email â†’ Reset password â†’ Login

### Next Steps

- [ ] Add rate limiting to forgot-password endpoint
- [ ] Consider adding "Resend email" option
- [ ] Add password reset to E2E tests
