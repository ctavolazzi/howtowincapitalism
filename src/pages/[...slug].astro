---
import { getCollection, render, getEntry } from 'astro:content';
import Base from '../layouts/Base.astro';
import { LoadingSpinner } from '../components';

// In SSR mode, we get the slug from params and look up the doc
const { slug } = Astro.params;

// Get the doc from the collection
const doc = await getEntry('docs', slug as string);

// 404 if doc not found
if (!doc) {
  return Astro.redirect('/404/');
}

const { Content } = await render(doc);
---

<Base title={doc.data.title} description={doc.data.description}>
  <!-- Auth Gate -->
  <div id="auth-gate" class="auth-gate">
    <LoadingSpinner />
  </div>

  <article id="content" style="display: none;">
    <h1>{doc.data.title}</h1>
    <Content />
  </article>
</Base>

<script>
  import { checkAuth } from '../lib/auth/api-client';

  const authGate = document.getElementById('auth-gate');
  const content = document.getElementById('content');

  async function verifyAuth() {
    const { authenticated } = await checkAuth();

    if (!authenticated) {
      window.location.href = '/login/?redirect=' + encodeURIComponent(window.location.pathname);
    } else {
      if (authGate) authGate.style.display = 'none';
      if (content) content.style.display = 'block';
    }
  }

  verifyAuth();
</script>

<style>
  article h1 {
    margin-top: 0;
  }

  .auth-gate {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 300px;
  }
</style>
