---
/**
 * @fileoverview Dynamic content page - catch-all route.
 *
 * Renders docs from the content collection based on URL slug.
 * Uses Astro's catch-all route pattern [...slug] to match any path.
 *
 * Features:
 * - SSR mode content lookup
 * - Auth gate requiring login
 * - 404 redirect for missing content
 *
 * @module pages/[...slug]
 * @see {@link module:content.config} - Content collections definition
 *
 * @author How To Win Capitalism Team
 * @since 1.0.0
 */
import { getCollection, render, getEntry } from 'astro:content';
import Base from '../layouts/Base.astro';

// In SSR mode, we get the slug from params and look up the doc
const { slug } = Astro.params;

// Get the doc from the collection
const doc = await getEntry('docs', slug as string);

// 404 if doc not found
if (!doc) {
  return Astro.redirect('/404/');
}

const { Content } = await render(doc);
---

<Base title={doc.data.title} description={doc.data.description}>
  <!-- Auth Gate -->
  <div id="auth-gate" class="auth-gate">
    <div class="loading-spinner"></div>
    <p>Loading...</p>
  </div>

  <article id="content" style="display: none;">
    <h1>{doc.data.title}</h1>
    <Content />
  </article>
</Base>

<script>
  import { checkAuth } from '../lib/auth/api-client';

  const authGate = document.getElementById('auth-gate');
  const content = document.getElementById('content');

  async function verifyAuth() {
    const { authenticated } = await checkAuth();

    if (!authenticated) {
      window.location.href = '/login/?redirect=' + encodeURIComponent(window.location.pathname);
    } else {
      if (authGate) authGate.style.display = 'none';
      if (content) content.style.display = 'block';
    }
  }

  verifyAuth();
</script>

<style>
  article h1 {
    margin-top: 0;
  }

  .auth-gate {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 300px;
    color: #72777d;
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #eaecef;
    border-top-color: #0645ad;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 1rem;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>
