---
/**
 * Registration Page
 *
 * Public page for new user registration.
 * Includes Turnstile CAPTCHA for bot protection.
 * Uses Base.astro layout for consistency.
 */
import Base from '../../layouts/Base.astro';
import RegisterForm from '../../components/auth/RegisterForm.astro';

// Get CSRF token and Turnstile site key from environment
// eslint-disable-next-line @typescript-eslint/no-explicit-any
const locals = Astro.locals as any;
const csrfToken = locals.csrfToken as string | undefined;
// eslint-disable-next-line @typescript-eslint/no-explicit-any
const runtime = locals.runtime as any;
const turnstileSiteKey = runtime?.env?.TURNSTILE_SITE_KEY as string | undefined;
---

<Base title="Create Account" description="Join the community and start your journey" hideNav={false}>
  {/* Load Turnstile script if site key is configured */}
  {turnstileSiteKey && (
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  )}

  <div class="auth-page">
    <div class="auth-header">
      <h1>Create Account</h1>
      <p>Join the community and start your journey</p>
    </div>

    <RegisterForm csrfToken={csrfToken} turnstileSiteKey={turnstileSiteKey} />
  </div>
</Base>

<script>
  import { checkAuth } from '../../lib/auth/api-client';

  // If already logged in, redirect away from register page
  async function checkIfAlreadyLoggedIn() {
    const { authenticated } = await checkAuth();

    if (authenticated) {
      window.location.href = '/';
    }
  }

  checkIfAlreadyLoggedIn();
</script>

<style>
  .auth-page {
    max-width: 500px;
    margin: 0 auto;
    padding: 2rem 1rem;
  }

  .auth-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .auth-header h1 {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    margin-top: 0;
  }

  .auth-header p {
    color: var(--color-text-muted, #72777d);
    margin: 0;
  }

  @media (min-width: 640px) {
    .auth-page {
      padding: 3rem 2rem;
    }
  }
</style>
