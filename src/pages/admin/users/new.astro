---
/**
 * @fileoverview Admin create user page.
 *
 * Admin-only form for creating new user accounts:
 * - Username, name, email, password fields
 * - Role selection (viewer, contributor, editor, admin)
 * - Admin-created users are pre-confirmed
 *
 * @module pages/admin/users/new
 * @see {@link module:pages/api/admin/users/create} - User creation API
 *
 * @author How To Win Capitalism Team
 * @since 1.0.0
 */
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create User | Admin | How To Win Capitalism</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <style>
    :root {
      --color-bg: #ffffff;
      --color-text: #202122;
      --color-text-muted: #72777d;
      --color-primary: #0645ad;
      --color-border: #a2a9b1;
      --color-surface: #f8f9fa;
      --color-danger: #c00;
      --color-success: #0a0;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--color-bg);
      color: var(--color-text);
      min-height: 100vh;
    }

    header {
      padding: 1rem 2rem;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .site-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-text);
      text-decoration: none;
    }

    .site-title:hover {
      color: var(--color-primary);
    }

    .back-link {
      color: var(--color-primary);
      text-decoration: none;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    main {
      max-width: 600px;
      margin: 0 auto;
      padding: 2rem;
    }

    .page-header {
      margin-bottom: 2rem;
    }

    .page-header h1 {
      font-size: 1.75rem;
      margin-bottom: 0.5rem;
    }

    .page-header p {
      color: var(--color-text-muted);
    }

    .form-card {
      background: var(--color-bg);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      padding: 2rem;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid var(--color-border);
      border-radius: 4px;
      font-size: 1rem;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
    }

    .form-group .hint {
      font-size: 0.85rem;
      color: var(--color-text-muted);
      margin-top: 0.25rem;
    }

    .error-message {
      padding: 0.75rem 1rem;
      background: #fee;
      border: 1px solid var(--color-danger);
      border-radius: 4px;
      color: var(--color-danger);
      margin-bottom: 1rem;
      display: none;
    }

    .success-message {
      padding: 0.75rem 1rem;
      background: #efe;
      border: 1px solid var(--color-success);
      border-radius: 4px;
      color: #070;
      margin-bottom: 1rem;
      display: none;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: 1px solid var(--color-border);
      border-radius: 4px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
    }

    .btn-primary {
      background: var(--color-primary);
      color: #fff;
      border-color: var(--color-primary);
    }

    .btn-primary:hover {
      opacity: 0.9;
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .form-actions {
      display: flex;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    .unauthorized {
      text-align: center;
      padding: 3rem;
    }

    .unauthorized h2 {
      color: var(--color-danger);
      margin-bottom: 1rem;
    }

    .loading {
      text-align: center;
      padding: 3rem;
      color: var(--color-text-muted);
    }
  </style>
</head>
<body>
  <header>
    <a href="/" class="site-title">How To Win Capitalism</a>
    <a href="/admin/users/" class="back-link">← Back to Users</a>
  </header>

  <main>
    <div id="content">
      <div class="loading">Loading...</div>
    </div>
  </main>

  <script>
    import { checkAuth } from '../../../lib/auth/api-client';

    const contentDiv = document.getElementById('content') as HTMLDivElement;

    async function init() {
      // Check if user is admin
      const { authenticated, user } = await checkAuth();

      if (!authenticated || user?.role !== 'admin') {
        contentDiv.innerHTML = `
          <div class="unauthorized">
            <h2>Access Denied</h2>
            <p>You must be an admin to access this page.</p>
            <a href="/login/?redirect=/admin/users/new/" class="btn btn-primary">Log In</a>
          </div>
        `;
        return;
      }

      // Render form
      renderForm();
    }

    function renderForm() {
      contentDiv.innerHTML = `
        <div class="page-header">
          <h1>Create New User</h1>
          <p>Admin-created users are pre-confirmed (no email verification required)</p>
        </div>

        <div class="form-card">
          <div id="error-message" class="error-message"></div>
          <div id="success-message" class="success-message"></div>

          <form id="create-user-form">
            <div class="form-group">
              <label for="username">Username</label>
              <input type="text" id="username" name="username" required
                pattern="[a-zA-Z0-9_]{3,20}"
                placeholder="johndoe" />
              <div class="hint">3-20 characters, letters, numbers, underscores only</div>
            </div>

            <div class="form-group">
              <label for="name">Full Name</label>
              <input type="text" id="name" name="name" required
                placeholder="John Doe" />
            </div>

            <div class="form-group">
              <label for="email">Email</label>
              <input type="email" id="email" name="email" required
                placeholder="john@example.com" />
            </div>

            <div class="form-group">
              <label for="password">Password</label>
              <input type="password" id="password" name="password" required
                minlength="8"
                placeholder="At least 8 characters" />
              <div class="hint">At least 8 characters with letters and numbers</div>
            </div>

            <div class="form-group">
              <label for="role">Role</label>
              <select id="role" name="role">
                <option value="viewer">Viewer (read-only)</option>
                <option value="contributor">Contributor (can contribute content)</option>
                <option value="editor">Editor (can edit content)</option>
                <option value="admin">Admin (full access)</option>
              </select>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary" id="submit-btn">Create User</button>
              <a href="/admin/users/" class="btn">Cancel</a>
            </div>
          </form>
        </div>
      `;

      // Attach form handler
      const form = document.getElementById('create-user-form') as HTMLFormElement;
      const errorMessage = document.getElementById('error-message') as HTMLDivElement;
      const successMessage = document.getElementById('success-message') as HTMLDivElement;
      const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(form);

        submitBtn.disabled = true;
        submitBtn.textContent = 'Creating...';
        errorMessage.style.display = 'none';
        successMessage.style.display = 'none';

        try {
          const response = await fetch('/api/admin/users/create/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              username: formData.get('username'),
              name: formData.get('name'),
              email: formData.get('email'),
              password: formData.get('password'),
              role: formData.get('role'),
            }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || 'Failed to create user');
          }

          // Success
          successMessage.innerHTML = `
            <strong>✓ User created successfully!</strong><br>
            Username: ${data.user.id}<br>
            <a href="/admin/users/">Return to user list</a>
          `;
          successMessage.style.display = 'block';
          form.reset();
        } catch (error) {
          errorMessage.textContent = error instanceof Error ? error.message : 'Failed to create user';
          errorMessage.style.display = 'block';
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Create User';
        }
      });
    }

    init();
  </script>
</body>
</html>
