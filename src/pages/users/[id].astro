---
/**
 * User Profile Page
 *
 * Public view of a user's profile.
 * Edit button only visible to owner/admin.
 */
import Base from '../../layouts/Base.astro';
import { getCollection, getEntry, render } from 'astro:content';
import OwnerGuard from '../../components/guards/OwnerGuard.astro';

// Generate static paths for all users
export async function getStaticPaths() {
  const users = await getCollection('users');
  return users.map((user) => ({
    params: { id: user.id },
    props: { user },
  }));
}

const { user } = Astro.props;
const { Content } = await render(user);

// Get tools owned by this user
const allTools = await getCollection('tools');
const userTools = allTools.filter((tool) => tool.data.owner.id === user.id);

// Get permission level description
function getLevelDescription(level: number): string {
  if (level >= 10) return 'Full system access';
  if (level >= 5) return 'Can edit all content';
  if (level >= 3) return 'Can create own content';
  return 'Read-only access';
}
---

<Base title={`${user.data.name} | Profile`}>
  <!-- Auth Gate -->
  <div id="auth-gate" class="auth-gate">
    <div class="loading-spinner"></div>
    <p>Loading...</p>
  </div>

  <div class="profile-page" id="content" style="display: none;">
    <!-- Profile Header -->
    <div class="profile-header">
      <div class="avatar-section">
        <img
          src={user.data.avatar || '/favicon.svg'}
          alt={user.data.name}
          class="profile-avatar"
          id="profile-avatar"
        />
        <OwnerGuard ownerId={user.id} visibility="private">
          <button class="edit-avatar-btn" id="edit-avatar-btn" slot="controls">
            üì∑ Change
          </button>
        </OwnerGuard>
      </div>

      <div class="profile-info">
        <h1 class="profile-name" id="profile-name">{user.data.name}</h1>
        <span class={`role-badge role-${user.data.role}`}>{user.data.role}</span>
        <p class="profile-level">
          Level {user.data.accessLevel} ‚Ä¢ {getLevelDescription(user.data.accessLevel)}
        </p>
      </div>

      <OwnerGuard ownerId={user.id} visibility="private">
        <div class="edit-actions" slot="controls">
          <button class="btn btn-primary" id="edit-profile-btn">‚úèÔ∏è Edit Profile</button>
        </div>
      </OwnerGuard>
    </div>

    <!-- Edit Form (hidden by default) -->
    <div class="edit-form" id="edit-form" style="display: none;">
      <h2>Edit Profile</h2>
      <form id="profile-form">
        <div class="form-group">
          <label for="edit-name">Display Name</label>
          <input type="text" id="edit-name" value={user.data.name} />
        </div>
        <div class="form-group">
          <label for="edit-avatar">Avatar URL</label>
          <input type="text" id="edit-avatar" value={user.data.avatar || ''} placeholder="/assets/avatar.jpg" />
        </div>
        <div class="form-group">
          <label for="edit-bio">Bio</label>
          <textarea id="edit-bio" rows={4} placeholder="Tell us about yourself..."></textarea>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" id="cancel-edit">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
      <p class="edit-note">
        <strong>Note:</strong> Changes persist in your browser's localStorage.
        Other users visiting your profile will see the static build-time data.
      </p>
    </div>

    <!-- About Section -->
    <section class="profile-section">
      <h2>About</h2>
      <div class="prose">
        <p id="profile-bio" class="user-bio">Loading...</p>
        <div class="content-from-markdown">
          <Content />
        </div>
      </div>
    </section>

    <!-- Permissions Section -->
    <section class="profile-section">
      <h2>Permissions</h2>
      <div class="permissions-grid">
        <div class={`permission-item ${user.data.accessLevel >= 3 ? 'granted' : 'denied'}`}>
          <span class="permission-icon">{user.data.accessLevel >= 3 ? '‚úÖ' : '‚ùå'}</span>
          <span>Create content</span>
        </div>
        <div class={`permission-item ${user.data.accessLevel >= 1 ? 'granted' : 'denied'}`}>
          <span class="permission-icon">{user.data.accessLevel >= 1 ? '‚úÖ' : '‚ùå'}</span>
          <span>Read public content</span>
        </div>
        <div class={`permission-item ${user.data.accessLevel >= 5 ? 'granted' : 'denied'}`}>
          <span class="permission-icon">{user.data.accessLevel >= 5 ? '‚úÖ' : '‚ùå'}</span>
          <span>Edit any content</span>
        </div>
        <div class={`permission-item ${user.data.accessLevel >= 10 ? 'granted' : 'denied'}`}>
          <span class="permission-icon">{user.data.accessLevel >= 10 ? '‚úÖ' : '‚ùå'}</span>
          <span>Delete content</span>
        </div>
        <div class={`permission-item ${user.data.accessLevel >= 10 ? 'granted' : 'denied'}`}>
          <span class="permission-icon">{user.data.accessLevel >= 10 ? '‚úÖ' : '‚ùå'}</span>
          <span>Manage users</span>
        </div>
      </div>
    </section>

    <!-- Owned Content Section -->
    {userTools.length > 0 && (
      <section class="profile-section">
        <h2>Owned Tools ({userTools.length})</h2>
        <div class="tools-list">
          {userTools.map((tool) => (
            <a href={`/tools/${tool.id}/`} class="tool-card">
              <span class="tool-title">{tool.data.title}</span>
              <span class={`tool-status status-${tool.data.status.toLowerCase().replace(' ', '-')}`}>
                {tool.data.status}
              </span>
              <span class={`visibility-badge ${tool.data.visibility}`}>
                {tool.data.visibility}
              </span>
            </a>
          ))}
        </div>
      </section>
    )}

    <!-- Back Link -->
    <div class="back-link">
      <a href="/users/">‚Üê Back to Users Directory</a>
    </div>
  </div>
</Base>

<script>
  import {
    getCurrentUser,
    authStore,
    getUserById,
    updateUserProfile,
    subscribeToUser,
    restoreAuthSubscription,
  } from '../../lib/auth';
  import { debug } from '../../lib/debug';

  // Auth Gate
  const authGate = document.getElementById('auth-gate');
  const contentEl = document.getElementById('content');

  async function checkAuth() {
    await new Promise((r) => setTimeout(r, 100));

    const state = authStore.get();
    if (state.isLoggedIn !== 'true') {
      window.location.href = '/login/?redirect=' + encodeURIComponent(window.location.pathname);
      return false;
    } else {
      if (authGate) authGate.style.display = 'none';
      if (contentEl) contentEl.style.display = 'block';
      return true;
    }
  }

  // Check auth first, then initialize the rest
  checkAuth().then((isAuthed) => {
    if (!isAuthed) return;

    // Restore auth subscription on page load
    restoreAuthSubscription();
    initializePage();
  });

  // Listen for logout
  authStore.subscribe(() => {
    const state = authStore.get();
    if (state.isLoggedIn !== 'true' && contentEl?.style.display === 'block') {
      window.location.href = '/login/';
    }
  });

  function initializePage() {

  const editProfileBtn = document.getElementById('edit-profile-btn');
  const editForm = document.getElementById('edit-form');
  const cancelEditBtn = document.getElementById('cancel-edit');
  const profileForm = document.getElementById('profile-form');
  const profileName = document.getElementById('profile-name');
  const profileAvatar = document.getElementById('profile-avatar') as HTMLImageElement;
  const profileBio = document.getElementById('profile-bio');

  // Get user ID from URL
  const userId = window.location.pathname.split('/').filter(Boolean).pop() || '';

  // Load user data from unified userStore
  function loadUserData() {
    const user = getUserById(userId);
    if (user) {
      if (profileName) profileName.textContent = user.name;
      if (profileAvatar) profileAvatar.src = user.avatar || '/favicon.svg';
      if (profileBio) profileBio.textContent = user.bio;

      // Update form inputs
      const nameInput = document.getElementById('edit-name') as HTMLInputElement;
      const avatarInput = document.getElementById('edit-avatar') as HTMLInputElement;
      const bioInput = document.getElementById('edit-bio') as HTMLTextAreaElement;

      if (nameInput) nameInput.value = user.name;
      if (avatarInput) avatarInput.value = user.avatar || '';
      if (bioInput) bioInput.value = user.bio || '';

      debug.log('profile', `Loaded user data for ${userId}`, user);
    }
  }

  // Initial load
  loadUserData();

  // Subscribe to user updates (will auto-update when profile is edited)
  subscribeToUser(userId, (user) => {
    if (user) {
      if (profileName) profileName.textContent = user.name;
      if (profileAvatar) profileAvatar.src = user.avatar || '/favicon.svg';
      if (profileBio) profileBio.textContent = user.bio;
      debug.log('profile', `User data updated via subscription: ${userId}`);
    }
  });

  // Edit button click
  editProfileBtn?.addEventListener('click', () => {
    if (editForm) {
      editForm.style.display = 'block';
      editForm.scrollIntoView({ behavior: 'smooth' });
    }
  });

  // Cancel edit
  cancelEditBtn?.addEventListener('click', () => {
    if (editForm) {
      editForm.style.display = 'none';
    }
  });

  // Save profile (uses unified userStore)
  profileForm?.addEventListener('submit', (e) => {
    e.preventDefault();

    const nameInput = document.getElementById('edit-name') as HTMLInputElement;
    const avatarInput = document.getElementById('edit-avatar') as HTMLInputElement;
    const bioInput = document.getElementById('edit-bio') as HTMLTextAreaElement;

    const newName = nameInput?.value || '';
    const newAvatar = avatarInput?.value || '/favicon.svg';
    const newBio = bioInput?.value || '';

    // Update via unified userStore (persists to localStorage automatically)
    const updated = updateUserProfile(userId, {
      name: newName,
      avatar: newAvatar,
      bio: newBio,
    });

    if (updated) {
      // Hide form
      if (editForm) editForm.style.display = 'none';

      debug.success('profile', `Profile updated for ${userId}`, { name: newName, avatar: newAvatar, bio: newBio });
      alert('Profile updated! Your changes have been saved.');
    } else {
      debug.warn('profile', `Failed to update profile for ${userId}`);
      alert('Failed to save profile. Please try again.');
    }
  });
  } // end initializePage
</script>

<style>
  .auth-gate {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 300px;
    color: #72777d;
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #eaecef;
    border-top-color: #0645ad;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 1rem;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .profile-page {
    max-width: 100%;
  }

  .profile-header {
    display: flex;
    align-items: flex-start;
    gap: 1.5rem;
    padding: 2rem;
    background: var(--color-surface, #f8f9fa);
    border: 1px solid var(--color-border, #a2a9b1);
    border-radius: 12px;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }

  .avatar-section {
    position: relative;
  }

  .profile-avatar {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: var(--color-surface-alt, #eaecef);
    object-fit: cover;
    border: 3px solid var(--color-bg, #fff);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .edit-avatar-btn {
    position: absolute;
    bottom: -5px;
    right: -5px;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    background: var(--color-bg, #fff);
    border: 1px solid var(--color-border, #a2a9b1);
    border-radius: 4px;
    cursor: pointer;
  }

  .profile-info {
    flex: 1;
    min-width: 200px;
  }

  .profile-name {
    font-size: 1.75rem;
    margin: 0 0 0.5rem;
    font-weight: 600;
  }

  .role-badge {
    display: inline-block;
    font-size: 0.875rem;
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    font-weight: 500;
    text-transform: capitalize;
  }

  .role-admin { background: #fef3c7; color: #92400e; }
  .role-editor { background: #dbeafe; color: #1e40af; }
  .role-contributor { background: #d1fae5; color: #065f46; }
  .role-viewer { background: #f3f4f6; color: #4b5563; }

  .profile-level {
    margin-top: 0.5rem;
    color: var(--color-text-muted, #666);
    font-size: 0.875rem;
  }

  .edit-actions {
    margin-left: auto;
  }

  .btn {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s;
  }

  .btn-primary {
    background: var(--color-link, #0645ad);
    color: white;
  }

  .btn-primary:hover {
    background: #0056b3;
  }

  .btn-secondary {
    background: var(--color-surface, #f8f9fa);
    color: var(--color-text, #202122);
    border-color: var(--color-border, #a2a9b1);
  }

  .btn-secondary:hover {
    background: var(--color-surface-alt, #eaecef);
  }

  /* Edit Form */
  .edit-form {
    background: var(--color-surface, #f8f9fa);
    border: 1px solid var(--color-border, #a2a9b1);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
  }

  .edit-form h2 {
    margin: 0 0 1rem;
    font-size: 1.25rem;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
    color: var(--color-text, #202122);
  }

  .form-group input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--color-border, #a2a9b1);
    border-radius: 6px;
    font-size: 1rem;
  }

  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--color-link, #0645ad);
  }

  .form-group textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--color-border, #a2a9b1);
    border-radius: 6px;
    font-size: 1rem;
    font-family: inherit;
    resize: vertical;
    min-height: 100px;
  }

  .user-bio {
    font-size: 1.1rem;
    line-height: 1.7;
    color: var(--color-text, #202122);
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px dashed var(--color-border, #a2a9b1);
  }

  .content-from-markdown {
    padding-top: 0.5rem;
  }

  .form-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
    margin-top: 1.5rem;
  }

  .edit-note {
    margin-top: 1rem;
    padding: 0.75rem;
    background: #fef3c7;
    border-radius: 6px;
    font-size: 0.75rem;
    color: #92400e;
  }

  /* Sections */
  .profile-section {
    margin-bottom: 2rem;
  }

  .profile-section h2 {
    font-size: 1.25rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--color-border, #a2a9b1);
  }

  .prose {
    line-height: 1.7;
    color: var(--color-text, #202122);
  }

  .prose h1, .prose h2, .prose h3 {
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .prose ul, .prose ol {
    margin: 1rem 0;
    padding-left: 1.5rem;
  }

  /* Permissions Grid */
  .permissions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 0.75rem;
  }

  .permission-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    background: var(--color-surface, #f8f9fa);
    border-radius: 6px;
    font-size: 0.875rem;
  }

  .permission-item.granted {
    background: #d1fae5;
  }

  .permission-item.denied {
    background: #fee2e2;
    color: #666;
  }

  /* Tools List */
  .tools-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .tool-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--color-surface, #f8f9fa);
    border: 1px solid var(--color-border, #a2a9b1);
    border-radius: 8px;
    text-decoration: none;
    color: inherit;
    transition: all 0.2s;
  }

  .tool-card:hover {
    border-color: var(--color-link, #0645ad);
    background: var(--color-bg, #fff);
  }

  .tool-title {
    flex: 1;
    font-weight: 500;
  }

  .tool-status {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
  }

  .status-active { background: #d1fae5; color: #065f46; }
  .status-in-development { background: #fef3c7; color: #92400e; }
  .status-sold { background: #dbeafe; color: #1e40af; }
  .status-deprecated { background: #f3f4f6; color: #4b5563; }

  .visibility-badge {
    font-size: 0.625rem;
    text-transform: uppercase;
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
  }

  .visibility-badge.public { background: #d1fae5; color: #065f46; }
  .visibility-badge.private { background: #fee2e2; color: #991b1b; }
  .visibility-badge.team { background: #dbeafe; color: #1e40af; }

  /* Back Link */
  .back-link {
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid var(--color-border, #a2a9b1);
  }

  .back-link a {
    color: var(--color-link, #0645ad);
    text-decoration: none;
  }

  .back-link a:hover {
    text-decoration: underline;
  }

  @media (max-width: 640px) {
    .profile-header {
      flex-direction: column;
      align-items: center;
      text-align: center;
    }

    .edit-actions {
      margin-left: 0;
      margin-top: 1rem;
    }
  }
</style>
