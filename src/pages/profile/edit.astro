---
/**
 * @fileoverview Edit profile page - authenticated profile editing.
 *
 * Protected route for editing the current user's profile.
 * Features multiple UI states for different scenarios:
 *
 * ## Error Handling
 * - Not logged in: Redirect to /login with countdown
 * - Profile not found: Show "Profile Setup Required" state
 * - System error: Show graceful error with retry option
 *
 * ## Flow
 * 1. Page renders with loading state
 * 2. Client-side script checks auth
 * 3. If authenticated, show edit form
 * 4. If not, redirect to login
 *
 * @module pages/profile/edit
 * @see {@link module:components/organisms/profile/ProfileForm} - Form component
 * @see {@link module:lib/auth/api-client} - Auth verification
 *
 * @author How To Win Capitalism Team
 * @since 1.0.0
 */
import Base from '../../layouts/Base.astro';
import ProfileForm from '../../components/organisms/profile/ProfileForm.astro';
import { fetchUserProfile, getAllUserIds, userExists } from '../../lib/api';

// For SSR, we pre-render with a placeholder profile
// The client will fetch the actual user's profile after auth check
const userIds = getAllUserIds();
let defaultProfile = null;
let ssrError: string | null = null;

try {
  if (userIds.length > 0) {
    defaultProfile = await fetchUserProfile(userIds[0], userIds[0]);
  }
} catch (err) {
  console.error('SSR profile fetch error:', err);
  ssrError = 'Failed to load profile template';
}
---

<Base title="Edit Profile">
  <div class="edit-page">
    <!-- State: Loading (shown initially) -->
    <div id="state-loading" class="state-container state-loading">
      <div class="loading-spinner"></div>
      <p class="state-text">Checking authentication...</p>
    </div>

    <!-- State: Auth Required (not logged in) -->
    <div id="state-auth-required" class="state-container state-auth" style="display: none;">
      <div class="state-card">
        <div class="state-icon">üîê</div>
        <h1>Login Required</h1>
        <p>You must be logged in to edit your profile.</p>
        <div class="state-actions">
          <a href="/login/?redirect=/profile/edit/" class="btn-primary">Log In</a>
          <a href="/" class="btn-secondary">Go Home</a>
        </div>
        <p class="redirect-notice" id="redirect-notice"></p>
      </div>
    </div>

    <!-- State: Profile Not Found (logged in but no profile) -->
    <div id="state-profile-missing" class="state-container state-warning" style="display: none;">
      <div class="state-card">
        <div class="state-icon">‚ö†Ô∏è</div>
        <h1>Profile Setup Required</h1>
        <p>Your account exists, but we couldn't find your profile data.</p>
        <p class="state-detail">This might happen if you're a new user or if there was a sync issue.</p>
        <div class="state-actions">
          <button id="btn-retry" class="btn-primary">Try Again</button>
          <a href="/profile/me/" class="btn-secondary">View Profile</a>
        </div>
        <p class="error-detail" id="profile-error-detail"></p>
      </div>
    </div>

    <!-- State: System Error -->
    <div id="state-error" class="state-container state-error" style="display: none;">
      <div class="state-card">
        <div class="state-icon">‚ùå</div>
        <h1>Something Went Wrong</h1>
        <p>We encountered an error while loading your profile.</p>
        <p class="error-detail" id="error-detail"></p>
        <div class="state-actions">
          <button id="btn-retry-error" class="btn-primary">Retry</button>
          <a href="/" class="btn-secondary">Go Home</a>
        </div>
      </div>
    </div>

    <!-- State: Edit Form (success) -->
    <div id="state-edit" class="state-container state-edit" style="display: none;">
      <div class="page-header">
        <h1>Edit Your Profile</h1>
        <a href="/profile/me/" class="back-link">‚Üê Back to Profile</a>
      </div>

      <div id="form-container">
        {defaultProfile ? (
          <ProfileForm profile={defaultProfile} />
        ) : ssrError ? (
          <div class="error-box">
            <p><strong>Template Error:</strong> {ssrError}</p>
            <p>Please refresh the page or try again later.</p>
          </div>
        ) : (
          <div class="error-box">
            <p>Unable to load profile form. Please refresh and try again.</p>
          </div>
        )}
      </div>
    </div>
  </div>
</Base>

<script>
  import { checkAuth } from '../../lib/auth/api-client';

  // DOM Elements
  const stateLoading = document.getElementById('state-loading');
  const stateAuthRequired = document.getElementById('state-auth-required');
  const stateProfileMissing = document.getElementById('state-profile-missing');
  const stateError = document.getElementById('state-error');
  const stateEdit = document.getElementById('state-edit');
  const redirectNotice = document.getElementById('redirect-notice');
  const profileErrorDetail = document.getElementById('profile-error-detail');
  const errorDetail = document.getElementById('error-detail');
  const btnRetry = document.getElementById('btn-retry');
  const btnRetryError = document.getElementById('btn-retry-error');

  // State management
  type PageState = 'loading' | 'auth-required' | 'profile-missing' | 'error' | 'edit';

  function showState(state: PageState) {
    // Hide all states
    [stateLoading, stateAuthRequired, stateProfileMissing, stateError, stateEdit].forEach(el => {
      if (el) el.style.display = 'none';
    });

    // Show requested state
    const stateMap: Record<PageState, HTMLElement | null> = {
      'loading': stateLoading,
      'auth-required': stateAuthRequired,
      'profile-missing': stateProfileMissing,
      'error': stateError,
      'edit': stateEdit,
    };

    const targetEl = stateMap[state];
    if (targetEl) {
      targetEl.style.display = 'flex';
    }
  }

  async function checkAuthAndLoad() {
    showState('loading');

    try {
      const { authenticated, user } = await checkAuth();

      // Check 1: Is user logged in?
      if (!authenticated || !user) {
        showState('auth-required');

        // Show countdown
        let countdown = 3;
        if (redirectNotice) {
          const updateCountdown = () => {
            redirectNotice.textContent = `Redirecting to login in ${countdown}s...`;
            countdown--;
            if (countdown >= 0) {
              setTimeout(updateCountdown, 1000);
            } else {
              window.location.href = '/login/?redirect=/profile/edit/';
            }
          };
          updateCountdown();
        }
        return;
      }

      // Success: Show edit form
      showState('edit');

      // Update form fields with user data from API
      const userIdInput = document.querySelector('input[name="userId"]') as HTMLInputElement;
      const usernameInput = document.getElementById('username') as HTMLInputElement;
      const bioInput = document.getElementById('bio') as HTMLTextAreaElement;
      const avatarInput = document.getElementById('avatarUrl') as HTMLInputElement;

      if (userIdInput) userIdInput.value = user.id;
      if (usernameInput) usernameInput.value = user.name || '';
      if (bioInput) bioInput.value = user.bio || '';
      if (avatarInput) avatarInput.value = user.avatar || '';

    } catch (err) {
      console.error('Edit page error:', err);
      showState('error');
      if (errorDetail) {
        errorDetail.textContent = err instanceof Error ? err.message : 'Unknown error occurred';
      }
    }
  }

  // Event handlers
  btnRetry?.addEventListener('click', () => checkAuthAndLoad());
  btnRetryError?.addEventListener('click', () => checkAuthAndLoad());

  // Initialize
  checkAuthAndLoad();
</script>

<style>
  .edit-page {
    max-width: 600px;
    margin: 0 auto;
    padding: 2rem 1rem;
    min-height: 60vh;
  }

  /* State Containers */
  .state-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 400px;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  /* Loading State */
  .state-loading {
    color: var(--color-text-muted, #72777d);
  }

  .loading-spinner {
    width: 48px;
    height: 48px;
    border: 3px solid var(--color-border-light, #eaecef);
    border-top-color: var(--color-primary, #0645ad);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: 1rem;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .state-text {
    font-size: 0.9375rem;
    margin: 0;
  }

  /* State Cards */
  .state-card {
    text-align: center;
    padding: 2.5rem 2rem;
    background: var(--color-surface, #f8f9fa);
    border: 1px solid var(--color-border, #a2a9b1);
    border-radius: 12px;
    max-width: 400px;
    width: 100%;
  }

  .state-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  .state-card h1 {
    font-size: 1.5rem;
    color: var(--color-text, #202122);
    margin: 0 0 0.75rem 0;
  }

  .state-card p {
    color: var(--color-text-muted, #72777d);
    margin: 0 0 0.5rem 0;
    line-height: 1.5;
  }

  .state-detail {
    font-size: 0.875rem;
    margin-bottom: 1.5rem !important;
  }

  .error-detail {
    font-size: 0.75rem;
    font-family: monospace;
    background: rgba(0, 0, 0, 0.05);
    padding: 0.5rem;
    border-radius: 4px;
    margin-top: 1rem !important;
    word-break: break-all;
  }

  .redirect-notice {
    font-size: 0.875rem;
    color: var(--color-text-muted, #72777d);
    margin-top: 1rem !important;
  }

  /* Buttons */
  .state-actions {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    margin-top: 1.5rem;
  }

  .btn-primary {
    padding: 0.75rem 1.5rem;
    background: var(--color-primary, #0645ad);
    color: white;
    text-decoration: none;
    border: none;
    border-radius: 6px;
    font-size: 0.9375rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
  }

  .btn-primary:hover {
    background: #003d99;
  }

  .btn-secondary {
    padding: 0.75rem 1.5rem;
    background: transparent;
    color: var(--color-text, #202122);
    text-decoration: none;
    border: 1px solid var(--color-border, #a2a9b1);
    border-radius: 6px;
    font-size: 0.9375rem;
    font-weight: 500;
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s;
  }

  .btn-secondary:hover {
    border-color: var(--color-primary, #0645ad);
    color: var(--color-primary, #0645ad);
  }

  /* Edit State */
  .state-edit {
    display: block !important;
    min-height: auto;
  }

  .state-edit[style*="flex"] {
    display: block !important;
  }

  .page-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--color-border-light, #eaecef);
  }

  .page-header h1 {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--color-text, #202122);
    margin: 0;
  }

  .back-link {
    color: var(--color-link, #0645ad);
    text-decoration: none;
    font-size: 0.875rem;
  }

  .back-link:hover {
    text-decoration: underline;
  }

  .error-box {
    padding: 1.25rem;
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: 8px;
    color: #991b1b;
  }

  .error-box p {
    margin: 0 0 0.5rem 0;
  }

  .error-box p:last-child {
    margin-bottom: 0;
  }
</style>
