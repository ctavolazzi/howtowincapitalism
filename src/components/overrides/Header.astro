---
/**
 * Custom Header Component
 *
 * BOX MODEL STRUCTURE:
 * ====================
 *
 * VIEWPORT (browser window)
 * ‚îî‚îÄ‚îÄ [Starlight wrapper - we don't control]
 *     ‚îî‚îÄ‚îÄ header.header-wrap         ‚Üê POSITION: fixed, full viewport width
 *         ‚îî‚îÄ‚îÄ div.header-content     ‚Üê MAX-WIDTH + PADDING for content bounds
 *             ‚îî‚îÄ‚îÄ div.header-row     ‚Üê FLEXBOX: title left, controls right
 *                 ‚îú‚îÄ‚îÄ a.title        ‚Üê LEFT: site name, can wrap
 *                 ‚îî‚îÄ‚îÄ div.actions    ‚Üê RIGHT: buttons, never wrap
 *
 * ‚îî‚îÄ‚îÄ nav.nav-menu                   ‚Üê POSITION: fixed, full screen overlay
 *     ‚îî‚îÄ‚îÄ div.nav-content            ‚Üê Same bounds as header-content
 *         ‚îî‚îÄ‚îÄ ul > li > a            ‚Üê Navigation links
 */
import type { Props } from '@astrojs/starlight/props';
import Search from '@astrojs/starlight/components/Search.astro';
---

<!--
  HEADER WRAPPER
  - Fixed to viewport (not parent)
  - Full width edge-to-edge
  - Stays at top when scrolling
-->
<header class="header-wrap">
  <!--
    HEADER CONTENT
    - Centers content with max-width
    - Adds horizontal padding
  -->
  <div class="header-content">
    <!--
      HEADER ROW
      - Flexbox container
      - Title on left, actions on right
    -->
    <div class="header-row">
      <a href="/" class="title">How To Win Capitalism</a>
      <div class="actions">
        <Search {...Astro.props} />
        <button
          type="button"
          class="menu-btn"
          aria-label="Menu"
          aria-expanded="false"
        >
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 6h18M3 12h18M3 18h18"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
</header>

<!--
  NAVIGATION MENU
  - Fixed overlay (covers entire viewport below header)
  - Hidden by default
  - Shown when menu button clicked
-->
<nav id="nav-menu" class="nav-menu" aria-label="Main navigation" hidden>
  <div class="nav-content">
    <ul class="nav-list">
      <li><a href="/">Home</a></li>
      <li><a href="/protocol/introduction/">Introduction</a></li>
      <li><a href="/field-notes/latest/">Latest Updates</a></li>
      <li><a href="/reports/">Reports</a></li>
    </ul>
  </div>
</nav>

<!-- Spacer to push content below fixed header -->
<div class="header-spacer"></div>

<style>
  /* ============================================
     CSS CUSTOM PROPERTIES
     ============================================ */
  :root {
    --header-height: 60px;
    --header-padding: 16px;
    --header-bg: #ffffff;
    --header-border: #e0e0e0;
    --text-color: #202122;
    --link-color: #0645ad;
    --hover-bg: #f5f5f5;
  }

  /* ============================================
     HEADER WRAPPER
     - Fixed to viewport top
     - Full width (viewport width, not parent)
     ============================================ */
  .header-wrap {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: var(--header-height);
    background: var(--header-bg);
    border-bottom: 1px solid var(--header-border);
    z-index: 10000;
  }

  /* ============================================
     HEADER CONTENT
     - Centers content
     - Adds horizontal padding
     ============================================ */
  .header-content {
    width: 100%;
    height: 100%;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 var(--header-padding);
  }

  /* ============================================
     HEADER ROW
     - Flexbox: title left, actions right
     - Vertically centered
     ============================================ */
  .header-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 100%;
    gap: 16px;
  }

  /* ============================================
     TITLE
     - Left side
     - Can wrap on narrow screens
     ============================================ */
  .title {
    font-family: "Linux Libertine", Georgia, serif;
    font-size: clamp(16px, 4vw, 20px);
    font-weight: 400;
    color: var(--text-color);
    text-decoration: none;
    line-height: 1.3;
    /* Allow shrinking but not below min-content */
    flex: 1 1 auto;
    min-width: 0;
  }

  .title:hover {
    color: var(--link-color);
  }

  /* ============================================
     ACTIONS (Search + Menu)
     - Right side
     - Never wrap or shrink
     ============================================ */
  .actions {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 0 0 auto; /* Don't grow, don't shrink */
  }

  /* ============================================
     MENU BUTTON
     ============================================ */
  .menu-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    padding: 0;
    background: transparent;
    border: 1px solid var(--header-border);
    border-radius: 4px;
    cursor: pointer;
    color: var(--text-color);
  }

  .menu-btn:hover {
    background: var(--hover-bg);
  }

  /* ============================================
     NAV MENU (Overlay)
     - Fixed, covers viewport below header
     - Hidden by default
     - Animated open/close (2026 microinteraction)
     ============================================ */
  .nav-menu {
    position: fixed;
    top: var(--header-height);
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--header-bg);
    z-index: 9999;
    overflow-y: auto;
    /* Animation */
    opacity: 1;
    transform: translateY(0);
    transition: opacity 0.25s ease-out, transform 0.25s ease-out;
  }

  .nav-menu[hidden] {
    display: block;
    opacity: 0;
    transform: translateY(-10px);
    pointer-events: none;
    visibility: hidden;
  }

  /* ============================================
     NAV CONTENT
     - Same bounds as header content
     ============================================ */
  .nav-content {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 var(--header-padding);
  }

  /* ============================================
     NAV LIST
     ============================================ */
  .nav-list {
    list-style: none;
    margin: 0;
    padding: 16px 0;
  }

  .nav-list li a {
    display: block;
    padding: 16px 0;
    font-size: 18px;
    color: var(--text-color);
    text-decoration: none;
    border-bottom: 1px solid #f0f0f0;
  }

  .nav-list li:last-child a {
    border-bottom: none;
  }

  .nav-list li a:hover {
    color: var(--link-color);
  }

  /* ============================================
     HEADER SPACER
     - Pushes content below fixed header
     ============================================ */
  .header-spacer {
    height: var(--header-height);
  }
</style>

<script>
  // Debug logging (client-side) - only in dev
  const DEBUG = import.meta.env?.DEV || localStorage.getItem('debug') === 'true';
  const log = DEBUG
    ? (...args: unknown[]) => console.log('üîç [header]', ...args)
    : () => {};

  // Get elements
  const menuBtn = document.querySelector('.menu-btn');
  const navMenu = document.getElementById('nav-menu');

  log('Header initialized', { menuBtn: !!menuBtn, navMenu: !!navMenu });

  // Toggle menu
  function toggleMenu() {
    const isOpen = !navMenu?.hidden;
    log('Menu toggle', { wasOpen: isOpen, nowOpen: !isOpen });
    if (navMenu) navMenu.hidden = isOpen;
    menuBtn?.setAttribute('aria-expanded', String(!isOpen));
  }

  // Close menu
  function closeMenu() {
    log('Menu close');
    if (navMenu) navMenu.hidden = true;
    menuBtn?.setAttribute('aria-expanded', 'false');
  }

  // Event listeners
  menuBtn?.addEventListener('click', toggleMenu);

  // Close on nav link click
  navMenu?.querySelectorAll('a').forEach(link => {
    link.addEventListener('click', (e) => {
      const target = e.currentTarget as HTMLAnchorElement;
      log('Nav link clicked', { href: target?.href });
      closeMenu();
    });
  });

  // Close on escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !navMenu?.hidden) {
      log('Escape pressed, closing menu');
      closeMenu();
    }
  });
</script>
