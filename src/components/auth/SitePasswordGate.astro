---
/**
 * SITE PASSWORD GATE
 *
 * Simple password protection for development/preview.
 * Shows a password prompt, stores unlock state in sessionStorage.
 *
 * This is NOT a replacement for auth - just a simple gate
 * to keep the site non-public during development.
 *
 * Usage:
 *   <SitePasswordGate>
 *     <YourProtectedContent />
 *   </SitePasswordGate>
 */

export interface Props {
  /** The password required to unlock (default: from env or 'unlockmenow') */
  password?: string;
}

// In production, use environment variable; fallback to dev password
const { password = import.meta.env.SITE_PASSWORD || 'unlockmenow' } = Astro.props;
---

<site-password-gate data-password={password}>
  <div class="gate" id="password-gate">
    <div class="gate__card">
      <h1 class="gate__title">How To Win Capitalism</h1>
      <p class="gate__subtitle">This site is currently in development.</p>

      <form class="gate__form" id="password-form">
        <label for="site-password" class="gate__label">Enter site password to continue:</label>
        <input
          type="password"
          id="site-password"
          name="password"
          class="gate__input"
          placeholder="Password"
          autocomplete="off"
          required
        />
        <button type="submit" class="gate__button">Enter</button>
        <p class="gate__error" id="password-error" hidden>Incorrect password. Try again.</p>
      </form>
    </div>
  </div>

  <div class="content" id="protected-content" hidden>
    <slot />
  </div>
</site-password-gate>

<script>
  class SitePasswordGateElement extends HTMLElement {
    connectedCallback() {
      const password = this.dataset.password || 'unlockmenow';
      const storageKey = 'htwc_site_unlocked';

      const gate = this.querySelector('#password-gate') as HTMLElement;
      const content = this.querySelector('#protected-content') as HTMLElement;
      const form = this.querySelector('#password-form') as HTMLFormElement;
      const input = this.querySelector('#site-password') as HTMLInputElement;
      const error = this.querySelector('#password-error') as HTMLElement;

      // Check if already unlocked this session
      if (sessionStorage.getItem(storageKey) === 'true') {
        gate.hidden = true;
        content.hidden = false;
        return;
      }

      // Show gate
      gate.hidden = false;
      content.hidden = true;

      // Handle form submit
      form.addEventListener('submit', (e) => {
        e.preventDefault();

        if (input.value === password) {
          sessionStorage.setItem(storageKey, 'true');
          gate.hidden = true;
          content.hidden = false;
          error.hidden = true;
        } else {
          error.hidden = false;
          input.value = '';
          input.focus();
        }
      });
    }
  }

  customElements.define('site-password-gate', SitePasswordGateElement);
</script>

<style is:global>
  /* Gate overlay */
  site-password-gate .gate {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 80vh;
    padding: var(--space-lg, 16px);
  }

  site-password-gate .gate__card {
    max-width: 400px;
    width: 100%;
    text-align: center;
    padding: var(--space-2xl, 32px);
    background: var(--color-surface, #f8f9fa);
    border: 1px solid var(--color-border, #a2a9b1);
    border-radius: 8px;
  }

  site-password-gate .gate__title {
    font-family: var(--font-serif, Georgia, serif);
    font-size: 1.5rem;
    font-weight: 400;
    margin: 0 0 var(--space-sm, 8px);
    color: var(--color-text, #202122);
    border: none;
    padding: 0;
  }

  site-password-gate .gate__subtitle {
    color: var(--color-text-muted, #54595d);
    margin: 0 0 var(--space-xl, 24px);
    font-size: var(--text-sm, 0.875rem);
  }

  site-password-gate .gate__form {
    display: flex;
    flex-direction: column;
    gap: var(--space-md, 12px);
  }

  site-password-gate .gate__label {
    font-size: var(--text-sm, 0.875rem);
    color: var(--color-text, #202122);
    text-align: left;
  }

  site-password-gate .gate__input {
    padding: var(--space-md, 12px);
    border: 1px solid var(--color-border, #a2a9b1);
    border-radius: 6px;
    font-size: var(--text-base, 1rem);
    font-family: inherit;
  }

  site-password-gate .gate__input:focus {
    outline: none;
    border-color: var(--color-link, #0645ad);
    box-shadow: 0 0 0 3px rgba(6, 69, 173, 0.1);
  }

  site-password-gate .gate__button {
    padding: var(--space-md, 12px) var(--space-lg, 16px);
    background: var(--color-text, #202122);
    color: var(--color-bg, #ffffff);
    border: none;
    border-radius: 6px;
    font-size: var(--text-base, 1rem);
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }

  site-password-gate .gate__button:hover {
    background: #333;
  }

  site-password-gate .gate__error {
    color: #dc2626;
    font-size: var(--text-sm, 0.875rem);
    margin: 0;
  }

  /* Content area */
  site-password-gate .content {
    /* No special styles needed - content flows normally */
  }
</style>
