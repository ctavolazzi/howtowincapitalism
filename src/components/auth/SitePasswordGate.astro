---
/**
 * SITE PASSWORD GATE
 *
 * Simple password protection for development/preview.
 * Shows a password prompt, stores unlock state in sessionStorage.
 *
 * Features:
 * - Cheeky animations on wrong password
 * - Honeypot field to catch bots
 * - Session-based unlock (resets on tab close)
 *
 * Usage:
 *   <SitePasswordGate>
 *     <YourProtectedContent />
 *   </SitePasswordGate>
 */

export interface Props {
  /** The password required to unlock (default: from env or 'unlockmenow') */
  password?: string;
}

// In production, use environment variable; fallback to dev password
const { password = import.meta.env.SITE_PASSWORD || 'unlockmenow' } = Astro.props;
---

<site-password-gate data-password={password}>
  <div class="gate" id="password-gate">
    <div class="gate__card" id="gate-card">
      <h1 class="gate__title">How To Win Capitalism</h1>
      <p class="gate__subtitle" id="gate-subtitle">This site is currently in development.</p>

      <form class="gate__form" id="password-form">
        <label for="site-password" class="gate__label">Enter site password to continue:</label>
        <input
          type="password"
          id="site-password"
          name="password"
          class="gate__input"
          placeholder="Password"
          autocomplete="off"
          required
        />

        <!-- Honeypot: invisible field that bots fill out -->
        <div class="gate__honeypot" aria-hidden="true">
          <label for="website">Website</label>
          <input
            type="text"
            id="website"
            name="website"
            tabindex="-1"
            autocomplete="off"
          />
        </div>

        <button type="submit" class="gate__button" id="submit-btn">Enter</button>
        <p class="gate__error" id="password-error" hidden>Incorrect password. Try again.</p>
      </form>

      <p class="gate__attempt-counter" id="attempt-counter" hidden></p>
    </div>
  </div>

  <div class="content" id="protected-content" hidden>
    <slot />
  </div>
</site-password-gate>

<script>
  class SitePasswordGateElement extends HTMLElement {
    private failCount = 0;

    // Sassy messages that escalate with each failed attempt
    private sassyMessages = [
      "Nope. Try again.",
      "Still wrong. Are you even trying?",
      "Three strikes... but I'll give you more chances.",
      "Maybe try 'password123'? Just kidding. That's not it either.",
      "At this point I'm impressed by your persistence.",
      "You know you could just... ask for the password?",
      "I admire your determination. Wrong answer though.",
      "Is this a brute force attack? How quaint.",
      "Fun fact: random guessing has a 0.0001% success rate here.",
      "Okay seriously, do you need a hint? It's not 'letmein'.",
      "Still here? Respect. Still wrong though.",
      "You've spent more time guessing than it takes to read the site.",
      "I'm not mad, just disappointed.",
      "The password remains un-guessed. As it should be.",
      "Legend says they're still guessing to this day...",
    ];

    connectedCallback() {
      const password = this.dataset.password || 'unlockmenow';
      const storageKey = 'htwc_site_unlocked';

      const gate = this.querySelector('#password-gate') as HTMLElement;
      const card = this.querySelector('#gate-card') as HTMLElement;
      const content = this.querySelector('#protected-content') as HTMLElement;
      const form = this.querySelector('#password-form') as HTMLFormElement;
      const input = this.querySelector('#site-password') as HTMLInputElement;
      const honeypot = this.querySelector('#website') as HTMLInputElement;
      const error = this.querySelector('#password-error') as HTMLElement;
      const subtitle = this.querySelector('#gate-subtitle') as HTMLElement;
      const counter = this.querySelector('#attempt-counter') as HTMLElement;
      const button = this.querySelector('#submit-btn') as HTMLButtonElement;

      // Check if already unlocked this session
      if (sessionStorage.getItem(storageKey) === 'true') {
        gate.hidden = true;
        content.hidden = false;
        return;
      }

      // Show gate
      gate.hidden = false;
      content.hidden = true;

      // Handle form submit
      form.addEventListener('submit', (e) => {
        e.preventDefault();

        // Honeypot check - if filled, silently reject (bot detected)
        if (honeypot.value) {
          // Pretend to process, then show generic error
          button.textContent = 'Checking...';
          setTimeout(() => {
            button.textContent = 'Enter';
            this.showBotMessage(card, subtitle);
          }, 1500);
          return;
        }

        if (input.value === password) {
          // Success! 
          sessionStorage.setItem(storageKey, 'true');
          card.classList.add('gate__card--success');
          subtitle.textContent = "Welcome! Loading...";
          setTimeout(() => {
            gate.hidden = true;
            content.hidden = false;
          }, 500);
        } else {
          // Wrong password - get sassy
          this.failCount++;
          this.handleFailure(card, input, error, subtitle, counter);
        }
      });
    }

    private handleFailure(
      card: HTMLElement,
      input: HTMLInputElement,
      error: HTMLElement,
      subtitle: HTMLElement,
      counter: HTMLElement
    ) {
      // Shake animation
      card.classList.remove('gate__card--shake', 'gate__card--nope', 'gate__card--spin');

      // Different animations based on fail count
      if (this.failCount % 5 === 0 && this.failCount > 0) {
        // Every 5th failure: spin!
        card.classList.add('gate__card--spin');
      } else if (this.failCount % 3 === 0) {
        // Every 3rd failure: dramatic nope
        card.classList.add('gate__card--nope');
      } else {
        // Normal shake
        card.classList.add('gate__card--shake');
      }

      // Update error message with sass
      const messageIndex = Math.min(this.failCount - 1, this.sassyMessages.length - 1);
      error.textContent = this.sassyMessages[messageIndex];
      error.hidden = false;

      // Show attempt counter after 3 failures
      if (this.failCount >= 3) {
        counter.hidden = false;
        counter.textContent = `Attempts: ${this.failCount}`;
      }

      // Easter eggs at certain thresholds
      if (this.failCount === 10) {
        subtitle.textContent = "You've unlocked: Stubborn Achievement ðŸ†";
      } else if (this.failCount === 20) {
        subtitle.textContent = "Okay this is getting weird.";
      } else if (this.failCount >= 50) {
        subtitle.textContent = "I genuinely don't know what to say anymore.";
      }

      input.value = '';
      input.focus();
    }

    private showBotMessage(card: HTMLElement, subtitle: HTMLElement) {
      // Special message for bots
      card.classList.add('gate__card--shake');
      subtitle.textContent = "ðŸ¤– Beep boop. Nice try, bot.";
    }
  }

  customElements.define('site-password-gate', SitePasswordGateElement);
</script>

<style is:global>
  /* Gate overlay */
  site-password-gate .gate {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 80vh;
    padding: var(--space-lg, 16px);
  }

  site-password-gate .gate__card {
    max-width: 400px;
    width: 100%;
    text-align: center;
    padding: var(--space-2xl, 32px);
    background: var(--color-surface, #f8f9fa);
    border: 1px solid var(--color-border, #a2a9b1);
    border-radius: 8px;
    transition: transform 0.3s ease, border-color 0.3s ease;
  }

  site-password-gate .gate__title {
    font-family: var(--font-serif, Georgia, serif);
    font-size: 1.5rem;
    font-weight: 400;
    margin: 0 0 var(--space-sm, 8px);
    color: var(--color-text, #202122);
    border: none;
    padding: 0;
  }

  site-password-gate .gate__subtitle {
    color: var(--color-text-muted, #54595d);
    margin: 0 0 var(--space-xl, 24px);
    font-size: var(--text-sm, 0.875rem);
    transition: color 0.3s ease;
  }

  site-password-gate .gate__form {
    display: flex;
    flex-direction: column;
    gap: var(--space-md, 12px);
  }

  site-password-gate .gate__label {
    font-size: var(--text-sm, 0.875rem);
    color: var(--color-text, #202122);
    text-align: left;
  }

  site-password-gate .gate__input {
    padding: var(--space-md, 12px);
    border: 1px solid var(--color-border, #a2a9b1);
    border-radius: 6px;
    font-size: var(--text-base, 1rem);
    font-family: inherit;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  site-password-gate .gate__input:focus {
    outline: none;
    border-color: var(--color-link, #0645ad);
    box-shadow: 0 0 0 3px rgba(6, 69, 173, 0.1);
  }

  /* Honeypot - completely hidden from humans */
  site-password-gate .gate__honeypot {
    position: absolute;
    left: -9999px;
    top: -9999px;
    opacity: 0;
    pointer-events: none;
    height: 0;
    width: 0;
    overflow: hidden;
  }

  site-password-gate .gate__button {
    padding: var(--space-md, 12px) var(--space-lg, 16px);
    background: var(--color-text, #202122);
    color: var(--color-bg, #ffffff);
    border: none;
    border-radius: 6px;
    font-size: var(--text-base, 1rem);
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
  }

  site-password-gate .gate__button:hover {
    background: #333;
  }

  site-password-gate .gate__button:active {
    transform: scale(0.98);
  }

  site-password-gate .gate__error {
    color: #dc2626;
    font-size: var(--text-sm, 0.875rem);
    margin: 0;
    font-weight: 500;
    transition: opacity 0.2s;
  }

  site-password-gate .gate__attempt-counter {
    margin-top: var(--space-md, 12px);
    font-size: var(--text-xs, 0.75rem);
    color: var(--color-text-muted, #54595d);
  }

  /* ========== ANIMATIONS ========== */

  /* Basic shake */
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
    20%, 40%, 60%, 80% { transform: translateX(8px); }
  }

  site-password-gate .gate__card--shake {
    animation: shake 0.6s ease-in-out;
  }

  /* Dramatic nope (bigger shake + red flash) */
  @keyframes nope {
    0%, 100% { transform: translateX(0) rotate(0deg); }
    10%, 50%, 90% { transform: translateX(-15px) rotate(-2deg); }
    30%, 70% { transform: translateX(15px) rotate(2deg); }
  }

  site-password-gate .gate__card--nope {
    animation: nope 0.5s ease-in-out;
    border-color: #dc2626 !important;
  }

  /* Spin (every 5th failure) */
  @keyframes spin-nope {
    0% { transform: rotate(0deg) scale(1); }
    25% { transform: rotate(5deg) scale(1.02); }
    50% { transform: rotate(-5deg) scale(0.98); }
    75% { transform: rotate(3deg) scale(1.01); }
    100% { transform: rotate(0deg) scale(1); }
  }

  site-password-gate .gate__card--spin {
    animation: spin-nope 0.8s ease-in-out;
  }

  /* Success animation */
  @keyframes success-pulse {
    0% { transform: scale(1); border-color: var(--color-border); }
    50% { transform: scale(1.02); border-color: #22c55e; }
    100% { transform: scale(1); border-color: #22c55e; }
  }

  site-password-gate .gate__card--success {
    animation: success-pulse 0.5s ease-in-out;
    border-color: #22c55e;
  }

  site-password-gate .gate__card--success .gate__subtitle {
    color: #22c55e;
  }

  /* Respect reduced motion */
  @media (prefers-reduced-motion: reduce) {
    site-password-gate .gate__card--shake,
    site-password-gate .gate__card--nope,
    site-password-gate .gate__card--spin,
    site-password-gate .gate__card--success {
      animation: none;
    }
  }
</style>
