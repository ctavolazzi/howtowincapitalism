# Work Effort: User Registration with Email Confirmation

## Status: ‚úÖ Implemented - Security Hardened
**Started:** 2025-12-11 23:00 PST
**Last Updated:** 2025-12-12 13:45 PST

## Objective

Implement user registration with email confirmation flow:
1. User fills registration form (username, name, email, password)
2. System creates unconfirmed user in Cloudflare KV
3. System sends confirmation email via Resend
4. User clicks link/button in email
5. System confirms email, updates database
6. User redirected to success page

## Test User (First Registration)

| Field | Value |
|-------|-------|
| Username | folktechnica |
| Name | Folk Technica |
| Email | folktechnica@gmail.com |
| Password | test_user1 |

## Technical Approach

**TDD (Test-Driven Development)**
- Write tests first
- Watch them fail
- Implement to make them pass

**Email Service: Resend**
- Modern, simple API
- Works great with Cloudflare Workers
- Free tier: 100 emails/day, 3000/month
- Easy HTML email templates

## Tasks

- [x] Write E2E tests for registration flow
- [x] Install Resend (`npm i resend`)
- [ ] Add RESEND_API_KEY to environment (Cloudflare dashboard)
- [x] Update KVUser interface (emailConfirmed, confirmToken)
- [x] Create POST /api/auth/register endpoint
- [x] Create GET /api/auth/confirm endpoint
- [x] Create /register/ page
- [x] Create confirmation success page
- [x] Create HTML email template
- [ ] Test with real email (folktechnica@gmail.com)
- [ ] Verify email confirmed status in KV
- [ ] Re-seed existing users with emailConfirmed: true

### Security Hardening (Added 2025-12-12)

- [x] Implement rate limiting (5/IP/15min login, 3/IP/hour registration)
- [x] Implement account lockout (20 attempts = 1 hour lockout)
- [x] Fix weak local session token (use crypto.randomUUID)
- [x] Create admin user management endpoints (/api/admin/users/*)
- [x] Create admin user management UI (/admin/users/*)
- [x] Add Turnstile CAPTCHA integration for registration
- [x] Add honeypot field for bot detection
- [x] Add time-based submission detection (>3s required)
- [x] Add disposable email domain blocking (40+ domains)

### Testing Automation (Added 2025-12-12)

- [x] Added Playwright `security-and-smoke.spec.ts` to assert Cloudflare Access blocks unauthenticated admin requests and that service tokens reach admin
- [x] Added `playwright-e2e` GitHub Action to wait for Pages preview URL and run the lean suite with Access enforcement on (secrets: `CF_ACCOUNT_ID`, `CF_API_TOKEN`, `CF_ACCESS_CLIENT_ID`, `CF_ACCESS_CLIENT_SECRET`)

### CMS Editing (Added 2025-12-12)

- [x] Added TinaCMS direct git-backed schema (`tina/config.ts`) for `src/content/docs` (title/description/pubDate/tags/weight/body) with repo media
- [x] Updated scripts so Tina builds before Astro (`dev` wraps `tinacms dev -c "astro dev"`, `build` runs `tinacms build && astro build`; `dev:astro` retained for Astro-only)
- [x] Ran `npm install` to regenerate `package-lock.json` with tinacms dependency
- [x] Added TinaCMS smoke test to `tests/security-and-smoke.spec.ts`
- [x] Added CMS documentation to `README.md` and `DEVELOPERS.md`
- [ ] Add `TINA_CLIENT_ID` and `TINA_TOKEN` secrets in Cloudflare Pages dashboard

## API Design

### POST /api/auth/register

**Request:**
```json
{
  "username": "folktechnica",
  "name": "Folk Technica",
  "email": "folktechnica@gmail.com",
  "password": "test_user1"
}
```

**Success (201):**
```json
{
  "success": true,
  "message": "Registration successful. Check your email to confirm."
}
```

**Errors:**
- 400: Validation error (weak password, invalid email)
- 409: Email already registered

### GET /api/auth/confirm?token=xxx

**Success:** Redirect to `/confirm/success/`
**Error:** Redirect to `/confirm/error/`

## KV Schema Update

```typescript
interface KVUser {
  // Existing fields...
  emailConfirmed: boolean;      // NEW
  confirmToken?: string;        // NEW (temporary)
  confirmTokenExpires?: string; // NEW (24h expiry)
}
```

## Email Template

Subject: "Confirm your How To Win Capitalism account"

```html
<h1>Welcome, Folk Technica!</h1>
<p>Click below to confirm your email:</p>
<a href="https://howtowincapitalism.com/api/auth/confirm?token=xxx">
  <button>Confirm Email</button>
</a>
```

## Environment Variables

```bash
RESEND_API_KEY=re_xxxxx  # Get from resend.com
```

## Notes

- Confirmation tokens expire in 24 hours
- Unconfirmed users cannot log in
- Admin can manually confirm users if needed

---

## Security Improvements (from MECANIK Comparison)

Based on comparison with [MECANIK DEV's Cloudflare Pages auth system](https://mecanik.dev/posts/cloudflare-pages-register-login-user-system/), these enhancements should be considered:

### üî¥ High Priority

| Gap | Current State | MECANIK Approach | Action |
|-----|---------------|------------------|--------|
| **CSRF Protection** | ‚ùå None | Encrypted tokens via HTMLRewriter | Add to `/register` form |
| **Password Hashing** | SHA-256 + static salt | PBKDF2 + per-user salt | Upgrade `kv-auth.ts` |
| **Rate Limiting** | ‚ùå None | Not specified (use CF WAF) | Add to registration endpoint |

### üü° Medium Priority

| Gap | Current State | MECANIK Approach | Action |
|-----|---------------|------------------|--------|
| **Dummy Form Fields** | ‚ùå None | Random hidden inputs | Confuse bots/scrapers |
| **Registration Validation** | Basic | No "email exists" message | Prevent user enumeration |

### Implementation Notes

**CSRF Token Structure (MECANIK approach):**
```typescript
const CSRF_TOKEN = JSON.stringify({
  i: request.headers.get('CF-Connecting-IP'),
  c: request.headers.get('CF-IPCountry'),
  u: request.headers.get('User-Agent'),
  e: Date.now() + 60000  // 1 minute expiry
});
// Encrypt and inject into form as hidden field
```

**Per-User Salt (upgrade path):**
```typescript
// Current (weak)
const data = encoder.encode(password + 'htwc_salt_2024');

// Better (PBKDF2 with random salt)
const salt = crypto.getRandomValues(new Uint8Array(16));
const key = await crypto.subtle.deriveBits({
  name: 'PBKDF2',
  salt: salt,
  iterations: 100000,
  hash: 'SHA-256'
}, passwordKey, 256);
// Store salt alongside hash
```

---

## Related

- [[20.01_authentication_and_activity_tracking]] - Original auth implementation
- [[10.10_security_audit]] - Comprehensive security audit
- [[2025-12-11_devlog]] - Today's session
- [MECANIK DEV Auth System](https://mecanik.dev/posts/cloudflare-pages-register-login-user-system/) - Reference implementation
